<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');
class User extends CI_Controller {

	function __construct()
	{
		parent::__construct();
		$this->load->library('form_validation');
		$this->load->library('user_auth');
		$this->load->model('User_model');
		$this->load->library("pagination");
	}

	
	/**
	 * Activate Acocunt	 *
	 * @return void
	 */
   public function activateaccount()
	{
		$data['activationCode']= stripslashes($this->input->get('activationCode'));
	
		 $result=$this->User_model->activate_account($data);
		 echo $result['message'];
	}
  
  
  /**
	 * Reset Password with email
	 *
	 * @param var,var
	 */
	public function ResetPassword($userTokenKey,$resetTokenKey)
	{ 
	   
		
		$view_data=array();
		$view_data['title'] = 'Reset Password';
        $data = array();
		$data['userTokenKey'] = $userTokenKey;
		$data['resetTokenKey'] = $resetTokenKey;
          	
		
		if($this->User_model->check_user_token($userTokenKey))
		{
	
		$response = $this->User_model->check_reset_password_token($userTokenKey,$resetTokenKey);
		if($response['status']==200)
		{

		$this->form_validation->set_rules('password', 'Password', 
		'trim|required|min_length[8]|xss_clean');
		$this->form_validation->set_rules('confirmPassword', 'Confirm Password', 'trim|required|min_length[8]|xss_clean|matches[password]');


		if ($this->form_validation->run())
		{
		
		$data['password'] = $this->form_validation->set_value('password');	

		$response = $this->User_model->Reset_password($data);
		if($response['status']==200)
		{
		$this->session->set_flashdata('success_msg', $response['message']);
	    redirect('user/ResetPassword/'.$userTokenKey."/". $resetTokenKey);
		}
		else
		{
	    $this->session->set_flashdata('error_msg', $response['message']);
		}					
		}
					
		
		}
		else
		{
		
		$this->session->set_flashdata('error_msg', $response['message']);
		}
		}
		else
		{
		
		$this->session->set_flashdata('error_msg', 'User token is invalid.');
		}
		if($this->user_auth->is_logged_in())
		{
		$data=$this->session->userdata('userInfo');
	    $groupId= $data->groupId; 
		$view_data['groupId']=$groupId;	
		}
		//pr($data);
	    $this->load->view('elements/header',$view_data);
		$this->load->view('user/reset_password',$data);
		$this->load->view('elements/footer');
	
		
		
}
  
  }

